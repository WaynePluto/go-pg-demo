# 身份与访问控制 (IACC) 功能开发计划

## 第一阶段：项目结构与数据库初始化

1. 构造api接口
    根据 `1.code-design.md` 的规划，参考 `promot/system.code.md`中的 扩展新业务规范 小节里的第一步。先创建一个`inft/iacc.go`文件，里面定义iacc模块的要用到的几个handler接口；然后在 `v1/router.go` 中引入接口依赖，根据对应的领域设计聚合根扩展 RegisterIACCXXX 方法。

2. 智能体创建模块目录：
    根据 `1.code-design.md` 的规划，请你直接创建 `iacc` 模块所需的所有子目录，使用智能体直接创建，不需要使用终端命令。
    *   `internal/modules/iacc/`
    *   `internal/modules/iacc/user/`
    *   `internal/modules/iacc/role/`
    *   `internal/modules/iacc/auth/`
    *   `internal/modules/iacc/service/`

3.  **终端运行数据库迁移命令**：
    创建用于 `iacc` 功能的数据库迁移文件。
    *   **终端命令**： `migrate create -ext sql -dir migration/db iacc_init`

4.  **智能体编写数据库迁移脚本**：
    请你先读取`migration/db`下面 template 模块的建表语句，参考其中的id、创建/更新时间字段类型以及响应的触发器等SQL语句。
    编辑上一步生成的 `...iacc_init.up.sql` 和 `...iacc_init.down.sql` 文件。
    *   **`up.sql`**：写入创建 `iacc_user`, `iacc_role`, `iacc_user_role` 三张表的 SQL 语句，遵循 `1.code-design.md` 中的表结构设计，按照需要创建索引、触发器、外键约束等等。
    *   **`down.sql`**：写入删除这三张表的 SQL 语句，用于数据库回滚。

5.  **终端运行数据库迁移**：
    执行迁移，创建数据库表。
    *   **命令**： `migrate -path migration/db -database "YOUR_DATABASE_CONNECTION_STRING" up`
    *   **注意**：需要将 `YOUR_DATABASE_CONNECTION_STRING` 替换为 config.dev.yaml 文件中实际的数据库连接字符串。

## 第二阶段：核心组件与业务模块开发

6.  **智能体创建权限枚举组件**：
    根据 `1.code-design.md` 的规划，创建用于定义权限常量的包。
    *   创建文件：`pkgs/permissions.go`
    *   在文件中定义权限相关的常量、枚举和描述。

7.  **智能体创建模块空文件**：
    在第一步创建的目录结构中，批量创建各个业务模块所需的 Go 源文件，只需要写入第一行package 语句。
    *   `internal/modules/iacc/user/type.go`
    *   `internal/modules/iacc/user/handler.go`
    *   `internal/modules/iacc/user/handler_test.go`
    *   `internal/modules/iacc/role/type.go`
    *   `internal/modules/iacc/role/handler.go`
    *   `internal/modules/iacc/role/handler_test.go`
    *   `internal/modules/iacc/auth/type.go`
    *   `internal/modules/iacc/auth/handler.go`
    *   `internal/modules/iacc/auth/handler_test.go`
    *   `internal/modules/iacc/service/permission_service.go`
    *   `internal/modules/iacc/service/permission_service_test.go`

8.  **智能体实现 `type.go`**：
    在 `user`, `role`, `auth` 模块的 `type.go` 文件中，定义业务模型、数据库表模型、API 的输入输出参数结构体。

9.  **智能体实现 `permission_service.go`**：
    在 `internal/modules/iacc/service/permission_service.go` 文件中，实现计算用户有效权限集的领域服务逻辑。

10. **智能体实现 `handler.go`**：
    参考template模块中 `handler.go`的实现方式。
    在 `user`, `role`, `auth` 模块的 `handler.go` 文件中，实现所有 API 接口的业务逻辑，包括参数绑定、验证、数据库操作和响应返回。
    实现完成后，检查是否存在语法错误。

11. 智能体检查iacc模块内的handler是否实现了`api/v1/intf/iacc.go`中定义的接口方法。

12. 智能体注册依赖：
    将新创建的 `handler`和`service` 构造函数注册到`wire.go`中，然后运行终端命令 `wire ./internal/app` 生成依赖注入代码。

## 第三阶段：中间件绑定路由

13. 智能体创建授权中间件：
    根据 `1.code-design.md` 的需求，创建新的授权中间件。
    *   创建文件：`internal/middlewares/permission.go`
    *   在文件中实现基于角色和权限的访问控制逻辑。

14. 智能体绑定授权中间件到v1路由上：
    根据`pkgs\permissions.go`定义的权限常量，检查`api\v1\router.go`路由，在需要的路由前使用PermissionMiddleware, 传入对应的permission Key。


## 第四阶段：测试与验证

15. 智能体编写单元测试：
    遵守`promot/system-code.md`中的测试代码规范，给 `user`, `role`, `auth` 的 handler文件中每个 API 编写单元测试。

16. 检索`test/v1/iacc`模块内有哪些测试文件，请你结合代码，根据依赖顺序，通过终端依次执行测试文件，根据测试结果修复代码。

17. 测试`internal/modules/iacc/user/handler.go`功能是否正常，运行`test/v1/iacc/user/user_test.go`测试，根据测试结果修改代码。