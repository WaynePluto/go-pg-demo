# 开发设计

## 1. 数据库表设计
   `user` 表
       `phone`: `VARCHAR` (UNIQUE)
       `password`: `VARCHAR` (存储前端MD5后的密文)
       `profile`: `JSONB`

   `role` 表
       `name`: `VARCHAR` (UNIQUE)
       `description`: `TEXT`

   `permission` 表
       `name`: `VARCHAR` (UNIQUE)
       `type`: `VARCHAR`
       `metadata`: `JSONB`

   `user_role` 关联表
       `user_id`: `UUID` (FOREIGN KEY -> users.id)
       `role_id`: `UUID` (FOREIGN KEY -> roles.id)
       `PRIMARY KEY (user_id, role_id)`

   `role_permission` 关联表
       `role_id`: `UUID` (FOREIGN KEY -> roles.id)
       `permission_id`: `UUID` (FOREIGN KEY -> permissions.id)
       `PRIMARY KEY (role_id, permission_id)`

## 2. API 设计

### 权限管理接口
```
POST      /permission                      # 创建权限
PUT       /permission/{id}                 # 更新权限
GET       /permission/{id}                 # 获取权限详情
DELETE    /permission/{id}                 # 删除权限
GET       /permission/list                 # 分页查询权限
```

### 角色管理接口
```
POST      /role                      # 创建角色
PUT       /role/{id}                 # 更新角色
GET       /role/{id}                 # 获取角色详情
DELETE    /role/{id}                 # 删除角色
GET       /role/list                 # 分页查询权限角色
POST      /role/{id}/permission      # 给角色分配权限
```

### 用户管理接口
```
POST      /user                      # 创建用户
PUT       /user/{id}                 # 更新用户
GET       /user/{id}                 # 获取用户详情
DELETE    /user/{id}                 # 删除用户
GET       /user/list                 # 分页查询权限用户
POST      /user/{id}/role            # 给用户分配角色
```

### 认证接口
```
POST   /auth/login    # 用户登录
POST   /auth/refresh  # 刷新token
GET    /auth/me       # 获取当前用户信息
```

## 3. Module 目录结构

```
internal/modules/
├── iacc/
│   ├── permission/
│   │   ├── type.go
│   │   └── handler.go
│   ├── role/
│   │   ├── type.go
│   │   └── handler.go
│   ├── user/
│   │   ├── type.go
│   │   └── handler.go
│   └── auth/
│       ├── type.go
│       └── handler.go

```

## 4. 需要的中间件

### 授权中间件
- 查询权限表type为`api`，metadata中的path和method字段匹配当前接口的权限，这些权限是当前接口所需要的权限
- 查询当前用户拥有的所有权限
- 检查当前用户的权限中是否有当前api所需的权限（有一个即可）

