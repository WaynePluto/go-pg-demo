# 具体开发设计

## 1. 数据库表设计

### user 表
- id (UUIDv7, PK)
- created_at (TIMESTAMPTZ)
- updated_at (TIMESTAMPTZ)  
- username (VARCHAR, UNIQUE)
- phone (VARCHAR, UNIQUE)
- password (VARCHAR) - 存储前端传来的MD5密文
- profile (JSONB) - 存储扩展信息

### role 表
- id (UUID, PK)
- created_at (TIMESTAMPTZ)
- updated_at (TIMESTAMPTZ)
- name (VARCHAR, UNIQUE)
- description (TEXT)
- permissions (JSONB) - 存储权限键数组

### user_role 表
- id (UUID, PK)
- created_at (TIMESTAMPTZ)
- updated_at (TIMESTAMPTZ)
- user_id (UUID, FK → user.id)
- role_id (UUID, FK → role.id)
- 唯一约束: (user_id, role_id)

## 2. API 设计

### 用户管理接口
```
POST   /user          # 创建用户
PUT    /user/{id}     # 更新用户
PATCH  /user/{id}     # 部分更新用户资料
GET    /user/{id}     # 获取用户详情
GET    /user/list     # 获取用户列表
POST   /user/{id}/role     # 分配角色
DELETE /user/{id}/role/{roleId}  # 移除角色
```

### 角色管理接口
```
POST   /role          # 创建角色
PUT    /role/{id}     # 更新角色
GET    /role/{id}     # 获取角色详情
GET    /role/list     # 获取角色列表
POST   /role/{id}/permission     # 分配权限
DELETE /role/{id}/permission/{permissionKey}  # 移除权限
```

### 认证接口
```
POST   /auth/login    # 用户登录
POST   /auth/refresh  # 刷新token
GET    /auth/me       # 获取当前用户信息
```

### 权限接口
```
GET    /user/{id}/permissions  # 获取用户有效权限
```

## 3. Module 目录结构

```
internal/modules/
├── iacc/
│   ├── user/
│   │   ├── type.go
│   │   ├── handler.go
│   │   └── handler_test.go
│   ├── role/
│   │   ├── type.go
│   │   ├── handler.go
│   │   └── handler_test.go
│   ├── auth/
│   │   ├── type.go
│   │   ├── handler.go
│   │   └── handler_test.go
│   └── service/
│       ├── permission_service.go
│       └── permission_service_test.go
```

## 4. 需要的中间件

### 授权中间件 (新增)
- 基于权限键的访问控制
- 支持角色和权限的校验

## 5. 需要扩展的 pkgs 组件

### 权限枚举组件 (新增)
- 在 `pkgs/permission.go` 中定义所有权限常量
- 预定义所有权限枚举
- 权限描述信息管理
